# GitLab CI/CD Pipeline for Flask + MySQL Application

stages:
  - test
  - lint
  - security
  - build
  - container-scanning

variables:
  # Global Variables
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  Flask: a7md12/flaskops
  DB: a7md12/flaskops-db
  # Image Tags
  FLASK_IMAGE_TAG: $CI_COMMIT_SHA
  MYSQL_IMAGE_TAG: $CI_COMMIT_SHA
  
# Container scanning
  CONTAINER_SCANNING_RECURSIVE: "true"
  CS_IMAGE_1: "${Flask}:${CI_COMMIT_SHA}"
  CS_IMAGE_2: "${DB}:${CI_COMMIT_SHA}"
  CS_DOCKERFILE_PATH_1: "$CI_PROJECT_DIR/flaskapp/Dockerfile"
  CS_DOCKERFILE_PATH_2: "$CI_PROJECT_DIR/mysql/Dockerfile"

# Cache Configuration
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .cache/pip
    - flaskapp/.coverage
    - flaskapp/__pycache__

include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Container-Scanning.gitlab-ci.yml


# ==================== TEST STAGE ====================
unit_tests: 
  stage: test
  image: python:3.9
  before_script:
    - cd flaskapp
    - pip install -r requirements.txt
  script:
    - echo "Running unit tests with coverage..."
    - python3 run_tests.py || true
    - echo "âœ… Unit tests completed!"
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: flaskapp/coverage.xml
    paths:
      - flaskapp/htmlcov/
    expire_in: 1 week
  only:
    - master
    - develop
    - merge_requests
  allow_failure: true

# ==================== QUALITY STAGE ====================
flake8:
  stage: lint
  image: python:3.9-slim
  before_script:
    - cd flaskapp
    - pip install -r lintReqs.txt
  script:
    - echo "ðŸ” Running code quality checks..."
    - flake8 app.py --max-line-length=88 --format=html --htmldir=flake8-report --exit-zero
    - echo "Running black formatting & isort import sorting checks..."
    - black --check --diff app.py >> ref-app.py || true
    - isort --check-only --diff app.py >> ref-app.py || true
  artifacts:
    paths:
      - flaskapp/flake8-report/
      - flaskapp/ref-app.py
    expire_in: 1 week
  only:
    - master
    - develop
    - merge_requests
  allow_failure: true

hadolint:
  image: hadolint/hadolint:latest-debian
  stage: lint
  script:
    - hadolint mysql/Dockerfile || true
    - hadolint flaskapp/Dockerfile || true
  only:
    - merge_requests
    - master
    - develop
  allow_failure: true

# ==================== SECURITY STAGE ====================
dep_scan:
  stage: security
  image: python:3.9
  before_script:
    - cd flaskapp
    - pip install pip-audit
  script:
    - echo "ðŸ”’ Running Dependency Scanning..."
    - pip-audit -f json --output=dep-scan-report.json -r requirements.txt || true
    - pip-audit -f json --output=lint-dep-scan-report.json -r lintReqs.txt || true
  artifacts:
    reports:
      dependency_scanning: flaskapp/dep-scan-report.json
    paths:
     - flaskapp/lint-dep-scan-report.json
    expire_in: 1 week
  only:
    - master
    - develop
    - merge_requests
  allow_failure: true

sast:
  stage: security


# ==================== BUILD STAGE ====================
build-flaskapp:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_HUB_PASS" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - echo "Building Flask application image..."
    - cd flaskapp
    - docker build -t $Flask:$FLASK_IMAGE_TAG  .
    - docker push $Flask:$FLASK_IMAGE_TAG
    - echo "âœ… Flask image built and pushed successfully!"
  only:
    - master
    - develop
    - merge_requests

build-mysql:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "$DOCKER_HUB_PASS" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - echo "Building MySQL database image..."
    - cd mysql
    - docker build -t $DB:$MYSQL_IMAGE_TAG .
    - docker push $DB:$MYSQL_IMAGE_TAG
    - echo "âœ… MySQL image built and pushed successfully!"
  only:
    - master
    - develop
    - merge_requests
  
# ==================== CONTAINER SCANNING STAGE ====================
container_scanning:
  rules: 
    - when: never

container_scanning_app:
  stage: container-scanning
  extends: container_scanning
  rules:   # re-enable with your own rules
    - if: '$CI_COMMIT_BRANCH == "master"'
  variables:
    CS_IMAGE: $CS_IMAGE_1
    CS_DOCKERFILE_PATH: $CS_DOCKERFILE_PATH_1

container_scanning_sql:
  stage: container-scanning
  extends: container_scanning
  rules:   # ðŸ‘ˆ re-enable with your own rules
    - if: '$CI_COMMIT_BRANCH == "master"'
  variables:
    CS_IMAGE: $CS_IMAGE_2
    CS_DOCKERFILE_PATH: $CS_DOCKERFILE_PATH_2
    CS_REGISTRY_USER: "$DOCKER_HUB_USER"
    CS_REGISTRY_PASSWORD: "$DOCKER_HUB_PASS"


# ==================== PIPELINE METRICS ====================
metrics:pipeline:
  stage: .post
  image: alpine:latest
  script:
    - |
      echo "ðŸ“Š Pipeline Metrics:"
      echo "Duration: $CI_PIPELINE_DURATION seconds"
      echo "Status: $CI_JOB_STATUS"
      echo "Commit: $CI_COMMIT_SHA"
      echo "Branch: $CI_COMMIT_REF_NAME"
      echo "Triggered by: $GITLAB_USER_NAME"
  only:
    - master
    - develop
    - merge_requests
  when: always
